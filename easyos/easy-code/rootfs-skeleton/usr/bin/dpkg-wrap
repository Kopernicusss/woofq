#!/bin/ash
#when dpkg package is installed, this script gets renamed to "dpkg"
# see packages-templates/dpkg/FIXUPHACK

ARGS=""
if [ -n "$1" ];then
 while [ -n "$1" ]
 do
  #do not put quotes around if a single word.
  if [ "${1/ /}" == "${1}" ];then
   ARGS="${ARGS} ${1}"
  else
   ARGS="${ARGS} \"${1}\""
  fi
  shift
 done
fi

exec /usr/bin/dpkg.bin $ARGS

#find out if any installed pkg changes...
#need to read /var/lib/dpkg/status, by paragraph...
touch /var/lib/dpkg/status
touch /root/.packages/user-installed-packages
DEBname=''; DEBstatus='';
while read aL
do
 if [ -z "$aL" ];then
  if [ -n "$DEBname" ];then #precaution
   case "$DEBstatus" in
    installed)
     grep -q -F "|${DEBname}|" /root/.packages/user-installed-packages
     if [ $? -ne 0 ];then
      grep -h -F "|${DEBname}|" /root/.packages/Packages-devuan-daedalus-* >> /root/.packages/user-installed-packages
     fi
    ;;
   esac
  fi
  DEBname=''; DEBstatus='';
  continue
 fi
 case "$aL" in
  Package: *) DEBname="${aL##* }" ;;
  Status: *)  DEBstatus="${aL##* }" ;;
 esac
done < /var/lib/dpkg/status

#find any removed packages
PKGi="$(cut -f 2,10,11 -d '|' /root/.packages/user-installed-packages | grep 'devuan|daedalus' | cut -f 1 -d '|' | tr '\n' ' ')"
for aP in $PKGi
do
 grep -q "^Package: ${aP}$" /var/lib/dpkg/status
 if [ $? -ne 0 ];then
  sed -i "/^${aP}_/d" /root/.packages/user-installed-packages
 fi
done

###end###
