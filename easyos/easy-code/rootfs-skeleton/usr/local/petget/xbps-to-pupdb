#!/bin/bash
#call from /etc/rc.d/rc.update
#rc.update calls xbps-user-postupdate, which expects /root/.packages/Packages-
# -void-current & -nonfree to be latest.

export LANG=C
L1='/usr/local/woofV'
E1='/mnt/wkg/data/woofV'

. /etc/DISTRO_SPECS

case "$DISTRO_TARGETARCH" in
 amd64) xARCH='x86_64' ;;
 *)     xARCH="$DISTRO_TARGETARCH" ;;
esac
export XBPS_ARCH="$xARCH"

rm -rf /tmp/woofV/xbps2pupdb 2>/dev/null
mkdir -p /tmp/woofV/xbps2pupdb
cd /tmp/woofV/xbps2pupdb

#got code from /usr/local/woofV/support/void0setup...
for aRD in $(find /var/db/xbps -mindepth 2 -maxdepth 2 -type f -name '*-repodata' | tr '\n' ' ')
do
 cp -f ${aRD} ${xARCH}-repodata.tar.zst
 tar --zstd -xf ${xARCH}-repodata.tar.zst
 rm ${xARCH}-repodata.tar.zst
 #remove any utf8 characters...
 iconv -c -f utf-8 -t ascii index.plist > index.plistFIXED
 mv -f index.plistFIXED index.plist
 echo
 ${E1}/support/cvt.sh > pupdb
 grep -q 'nonfree' <<< ${aRD}
 if [ $? -eq 0 ];then
  sed -i -e 's%[|]current[|]%|current/nonfree|%' pupdb
  cp -f pupdb /root/.packages/Packages-void-current-nonfree
 else
  cp -f pupdb /root/.packages/Packages-void-current
 fi
done

###end###
