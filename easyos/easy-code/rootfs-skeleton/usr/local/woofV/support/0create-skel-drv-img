#!/bin/ash
#20240122
#optional: pass in: size-1st, size-2nd

. /etc/DISTRO_SPECS
. /etc/rc.d/PUPSTATE

losetup 2>&1 | grep -q BusyBox
if [ $? -eq 0 ];then
 echo "You have Busybox losetup. Need the full version in util-linux pkg."
 exit 1
fi

#woofV will use /mnt/wkg/data/woofV to build easyVoid.
mkdir -p /mnt/wkg/data/woofV

S1=7 #MiB
S2=880 #MiB
[ $1 ] && S1=$1
[ $2 ] && S2=$2

T1=$((1+${S1}+${S2}+1)) #total size of file.

#create an empty file...
echo "Creating empty skeleton image file, size ${T1}MiB..."
SKEL="easy-skeleton-${S1}-${S2}-${T1}mb.img"
if [ -e /mnt/wkg/data/woofV/${SKEL} ];then
 rm -f /mnt/wkg/data/woofV/${SKEL}
fi
if [ -e /mnt/wkg/data/woofV/${SKEL}.gz ];then
 rm -f /mnt/wkg/data/woofV/${SKEL}.gz
fi
dd if=/dev/zero of=/mnt/wkg/data/woofV/${SKEL} bs=1M count=${T1}
sync

#1st part
LOOPn="$(losetup -f)"
losetup ${LOOPn} /mnt/wkg/data/woofV/${SKEL}

echo 'Creating a new dos partition table, using fdisk...'
busybox echo -e 'o\nw\n' | fdisk ${LOOPn}
sync
sleep 1
partprobe ${LOOPn}
#echo change > /sys/block/${LOOPn##*/}/uevent
sleep 1

echo "Creating ${S1}MiB esp partition..."
#2048 512-byte sectors is 1MiB...
busybox echo -e "n\np\n1\n2048\n+${S1}M\nw\n" | fdisk ${LOOPn}
sync
#set partition-id to efi...
busybox echo -e 't\nef\nw' | fdisk ${LOOPn}
sync
#set the boot flag...
busybox echo -e 'a\nw' | fdisk ${LOOPn}
sync
sleep 5
partprobe ${LOOPn}
#echo change > /sys/block/${LOOPn##*/}/uevent
sleep 1

echo "Creating ${S2}MiB second partition..."
echo -e "n\np\n2\n\n+${S2}M\nw" | fdisk ${LOOPn}
sync
sleep 8
partprobe ${LOOPn}
#echo change > /sys/block/${LOOPn##*/}/uevent
sleep 2
sync
losetup -d ${LOOPn}
sleep 1

echo "Creating fat12 filesystem..."
LOOPn="$(losetup -f)"
OFF1b=$((1024*1024)) #1MiB
losetup -o ${OFF1b} --sizelimit ${S1}MiB --sector-size 512 ${LOOPn} /mnt/wkg/data/woofV/${SKEL}
#too small for fat16
mkdosfs -F 12 -n EASYVOID1 -S 512 ${LOOPn}
sync

mkdir -p /mnt/wkg/data/woofV/mntpt1
busybox mount -t vfat ${LOOPn} /mnt/wkg/data/woofV/mntpt1
mkdir -p /mnt/wkg/data/woofV/mntpt1/EFI/BOOT
sync
busybox umount /mnt/wkg/data/woofV/mntpt1
losetup -d ${LOOPn}
sleep 1

echo "Creating ext4 f.s. in 2nd partition..."
LOOPn="$(losetup -f)"
OFF2m=$((1+${S1}))
OFF2b=$((${OFF2m}*1024*1024)) #bytes
losetup -o ${OFF2b} --sizelimit ${S2}MiB --sector-size 512 ${LOOPn} /mnt/wkg/data/woofV/${SKEL}

#ext4 f.s. without journal, encrypt...
mke2fs -q -t ext4 -O encrypt,^has_journal,^64bit -L easyvoid2 -m 0 -b 4096 ${LOOPn}
sync
sleep 1

mkdir -p /mnt/wkg/data/woofV/mntpt2
busybox mount -t ext4 ${LOOPn} /mnt/wkg/data/woofV/mntpt2
mkdir -p /mnt/wkg/data/woofV/mntpt2/easyvoid
sync
busybox umount /mnt/wkg/data/woofV/mntpt2
losetup -d ${LOOPn}
sleep 1

gzip -k /mnt/wkg/data/woofV/${SKEL}
sync
echo "/mnt/wkg/data/woofV/${SKEL} has been created"
###end###
